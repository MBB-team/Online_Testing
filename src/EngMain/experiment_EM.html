<!-- Code for Engage/Maintain RSVP task online using Javascript and jsPsych library
Author: William Hopper (williamjthopper@gmail.com)
Created: 01/06/2020

Data Output:
-
Per trial:
-

-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-utf-8"/>
  <title> Attention </title>
  <script   src  = "jsPsych-master/jspsych.js"></script> <!-- import the library, should be downloaded and put into your experiment folder -->
  <link     href = "jsPsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <script   src  = "getBrowserInfo.js"></script> <!-- add the external functions-->
  <script   src  = "jsPsych-master/plugins_WH/fullscreen-WH-EM.js"></script> <!-- plugin that Juliana modified -->
  <script   src  = 'jsPsych-master/plugins_WH/jspsych-instructions-WH-EM.js'></script>
  <script   src  = 'jsPsych-master/plugins_WH/jspsych-html-button-response-WH-EM.js'></script>


</head>
<body>
  <div id='jspsych-target' style='width:auto; height:auto; position:relative;'></div>
  <canvas class = "canvas" id="myCanvas"></canvas>
</body>

<script type="application/javascript">

  // --------------------------------- PARAMETERS --------------------------------//

  // What to do
  const cfg = {debug:        false,
               cheat:        false,
               instructions: false,
               training:     false};

  // Configuration parameters of experiment
  const exp = {nbTrials:     48};


  // --------------------------------- INITIALISATION  --------------------------- //

  // Checks if the browser is Chrome or Firefox (best compatibility)
  var browserInfo = getBrowserInfo();

  if (browserInfo.browser !== 'Chrome' && browserInfo.browser !== 'Firefox') {
    var wrong_browser = {
      type: 'html-button-response-WH-EM',
      choices: [],
      stimulus: "<p>Cette exp\351rience n'est compatible que avev Google Chrome ou Mozilla Firefox. </p>"
               +"<p> Veuillez rouvrir l'exp\351rience dans l'un de ces navigateurs. </p>"
             };

             jsPsych.init({
               timeline: [wrong_browser]
             })

  } else { // If the browswer is ok, proceed to the experiment

    // General function that is needed
    function randi(min, max) { // min and max included (acts like randi of Matlab)
          return Math.floor(Math.random() * (max - min + 1) + min);
    }

    // Create "Variable/function" that makes sure you remain in FullScreen
    var firstFullscreen = {
      type: 'fullscreen-WH-EM',
      message:"<p>  Pour participer \340 l'exp\351rience, votre navigateur doit \352tre en mode plein \351cran. </p>"+"<p> La sortie du mode plein \351cran suspendra l'exp\351rience. </p>"+"<p> Veuillez cliquer sur le bouton ci-dessous pour activer le mode plein \351cran et continuer. </p>",
      button_label: 'Mettre en plein \351cran',
      delay_after: 300,
      check_fullscreen: true
    };

    var fullscreenExp = {
          type: 'fullscreen-WH-EM',
          message: "Vous devez \352tre en mode plein \351cran pour continuer l'exp\351rience!  <br></br> Veuillez cliquer sur le bouton ci-dessous pour passer en mode plein \351cran.<br></br><p>",
          fullscreen_mode: false,
    }


    // ------------------------------ PRE-LOAD MEDIA ----------------------------- //

    // instructions
    var instrImg = [];
    var instrImg_html = [];
    for (var t=1; t <= nbInstr; t++){
      instrImg[t-1] = 'Stimuli/Instructions/Slide'+t+'.PNG'; // pre-load all instructions
      instrImg_html[t-1] = '<img src="'+instrImg[t-1]+'"  id="image-instructions" style="height:'+screen.height/1.25+'px"></img>';
    };

    function updateLoadedCount(nLoaded){
      var percentcomplete = nLoaded / (instrImg.length + numbersImg.length + 1)  * 100;
      //console.log('Loaded '+percentcomplete+'% of images');
    }

    // --------------------------------- SAVING DATA  ----------------------------//

        // CODE TO SAVE FULLDATA AT THE END

        function saveData() {
              var xhr = new XMLHttpRequest();
              xhr.open('POST', 'write_data_EM.php'); // change it to point to php script.
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.onload = function() {
                    if(xhr.status == 200){
                         console.log(xhr);
                         var response = JSON.parse(xhr.responseText); // $.parseJSON
                         console.log(response);
                   } if(response.success){ console.log("Data saved");
                   } else {console.log("Data not saved");}
             };
             xhr.send(jsPsych.data.getLastTrialData().json()); // allows to save it every trial

       }

    // ------------------------------ BEGIN EXPERIMENT --------------------------- /
    var today           = new Date();
    var date            = today.getHours()+":"+today.getMinutes()+" "+today.getDate()+'-'+(today.getMonth()+1)+'-'+today.getFullYear();

    var exp_timeline = [];

    if (cfg.debug == false){
      jsPsych.pluginAPI.preloadImages([instrImg],
      function(){ startExperiment();},
      function(nLoaded){updateLoadedCount(nLoaded);});
    }


    function startExperiment(){

      exp_timeline.push(firstFullscreen);

      // Execute the experiment
      var instructions = {
        type: 'instructions-WH-EM',
        pages: instrImg_html,
        show_clickable_nav: true
      };

      if (cfg.instructions == TRUE){
        exp_timeline.push(instructions);
      };


      // Generate trials
      var task = rsvpEM();
      for (var i = 0; i < task.length; i++) {
        exp_timeline.push(task[i]);
      };

      jsPsych.init({
        timeline: exp_timeline,
        show_progress_bar: true,
        on_trial_finish: function(){
          jsPsych.data.addProperties({date: date});
          saveData();
        },
        on_finish: function(){
          //jsPsych.data.displayData(); // Disable once online, use to look at data while coding
          //document.write('<p><br></br><br></br><center>Thank you for participating! <br></br> Your data code is <strong>'+subject_id+'</strong>.<br></center><p>')
          endTask();
        }
      });
    } // end of startExperiment

    function endTask() {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', 'endTask.php');
          xhr.onload = function() {
                var reponse = "";
                if(xhr.status == 200){
                      var response = JSON.parse(xhr.responseText); // $.parseJSON
                }
                if(response.success){
                      console.log("run updated");
                      window.location.replace("/"); //redirect to home page
                }
                else {
                      console.log("error on update run");
                      console.log(xhr);
                      console.log(response);
                      //redirect to home page after 5 secs if error
                      setTimeout(function (){
                           window.location.replace("/");
                     },
                     5000);
               }
         };
         xhr.send();
   };
}; // end of browser checking
</script>
</html>
